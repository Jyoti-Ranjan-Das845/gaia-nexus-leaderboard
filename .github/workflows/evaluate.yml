name: Evaluate Agent on GAIA Benchmark

permissions:
  contents: write

on:
  pull_request:
    paths:
      - 'submissions/**'
  workflow_dispatch:
    inputs:
      agent_image:
        description: 'Docker image of purple agent to evaluate'
        required: true
        default: 'jyotirdas845/gaia-purple-agent:latest'
      level:
        description: 'GAIA difficulty level (1, 2, or 3)'
        required: false
        default: '1'
      task_ids:
        description: 'Comma-separated task IDs to evaluate (e.g., "0,1,2")'
        required: false
        default: '0,1,2'

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull green agent image
        run: docker pull jyotirdas845/gaia-green-agent:latest

      - name: Pull purple agent image
        run: |
          AGENT_IMAGE="${{ github.event.inputs.agent_image || 'jyotirdas845/gaia-purple-agent:latest' }}"
          docker pull $AGENT_IMAGE

      - name: Run GAIA evaluation
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          AGENT_IMAGE="${{ github.event.inputs.agent_image || 'jyotirdas845/gaia-purple-agent:latest' }}"
          LEVEL="${{ github.event.inputs.level || '1' }}"
          TASK_IDS="${{ github.event.inputs.task_ids || '0,1,2' }}"

          # Start green agent
          docker run -d --name gaia-green \
            --network host \
            -e HF_TOKEN=$HF_TOKEN \
            jyotirdas845/gaia-green-agent:latest

          # Wait for green agent to be ready
          echo "Waiting for green agent to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:9001/.well-known/agent-card.json > /dev/null 2>&1; then
              echo "Green agent is ready!"
              break
            fi
            sleep 1
          done

          # Start purple agent
          docker run -d --name gaia-purple \
            --network host \
            -e OPENAI_API_KEY=$OPENAI_API_KEY \
            $AGENT_IMAGE

          # Wait for purple agent to be ready
          echo "Waiting for purple agent to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:9002/.well-known/agent-card.json > /dev/null 2>&1; then
              echo "Purple agent is ready!"
              break
            fi
            sleep 1
          done

          echo "Both agents are ready!"

          # Create scenario TOML for evaluation
          cat > /tmp/scenario.toml <<EOF
          [green_agent]
          endpoint = "http://localhost:9001"

          [[participants]]
          role = "executor"
          endpoint = "http://localhost:9002"

          [config]
          level = $LEVEL
          split = "validation"
          task_indices = [$(echo $TASK_IDS | sed 's/,/, /g')]
          EOF

          echo "Scenario configuration:"
          cat /tmp/scenario.toml

          # Copy scenario file into green agent container
          docker cp /tmp/scenario.toml gaia-green:/tmp/scenario.toml

          # Run evaluation using client_cli (use uv run to access dependencies in venv)
          echo "Starting evaluation..."
          docker exec gaia-green uv run python -m agentbeats.client_cli /tmp/scenario.toml /tmp/raw_results.json || echo "Evaluation failed"

          # Copy results out of container
          docker cp gaia-green:/tmp/raw_results.json /tmp/raw_results.json 2>/dev/null || echo '{"results":[]}' > /tmp/raw_results.json

          # Parse and format results for leaderboard
          mkdir -p results
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          AGENT_NAME=$(echo $AGENT_IMAGE | tr '/:' '_')

          python3 scripts/parse_results.py \
            /tmp/raw_results.json \
            results/${AGENT_NAME}_${TIMESTAMP}.json \
            "$AGENT_IMAGE" \
            "$LEVEL" \
            "$TASK_IDS"

      - name: Stop containers
        if: always()
        run: |
          docker stop gaia-green gaia-purple || true
          docker rm gaia-green gaia-purple || true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: results/*.json

      - name: Commit results
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add results/
          git commit -m "Add evaluation results for ${{ github.event.inputs.agent_image }}" || true
          git push || true
